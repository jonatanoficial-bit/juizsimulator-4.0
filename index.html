<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Jogo do Juiz 4.0 ‚Äì Vale Produ√ß√£o</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background-color:#020617;
      color:#e5e7eb;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    /* Fundo da sala de julgamento */
    .bg-court {
      background-image: url("https://jonatanoficial-bit.github.io/juizsimulator-4.0/img/tribunal.png");
      background-size: cover;
      background-position: center;
    }

    /* Fundo do escrit√≥rio do juiz / telas internas */
    .bg-office {
      background-image: url("https://jonatanoficial-bit.github.io/juizsimulator-4.0/img/escritorio.png");
      background-size: cover;
      background-position: center;
    }

    /* Se quiser usar em alguma tela espec√≠fica do STJ no futuro */
    .bg-stj {
      background-image: url("https://jonatanoficial-bit.github.io/juizsimulator-4.0/img/stj.png");
      background-size: cover;
      background-position: center;
    }

    .glass {
      background-color: rgba(15,23,42,0.88);
      backdrop-filter: blur(18px);
    }

    .btn-main {
      background: linear-gradient(135deg,#22c55e,#16a34a);
      color:#0f172a;
      border-radius: 0.75rem;
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      font-weight: 600;
      transition: 0.2s;
    }

    .btn-main:hover {
      filter: brightness(1.1);
    }

    .btn-soft {
      background: rgba(255,255,255,0.08);
      padding: 0.5rem 1rem;
      border-radius: 0.75rem;
      font-size: 0.875rem;
      transition: 0.2s;
    }

    .btn-soft:hover {
      background: rgba(255,255,255,0.18);
    }

    pre {
      white-space: pre-wrap;
      word-wrap: break-word;
    }
  </style>
</head>
<body>
  <!-- Sons -->
  <audio id="s-gavel" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_b8e7f6b3a0.mp3?filename=judge-gavel-182004.mp3"></audio>
  <audio id="s-murmur" src="https://cdn.pixabay.com/download/audio/2021/09/16/audio_7b4b2d7f6c.mp3?filename=crowd-murmur-ambient-75537.mp3"></audio>
  <audio id="s-amb" src="https://cdn.pixabay.com/download/audio/2022/10/25/audio_6d02f9f2c3.mp3?filename=large-room-ambience-124106.mp3" loop></audio>

  <div id="app" class="min-h-screen"></div>

<script>
/* ==========================
   ESTADO GLOBAL
   ========================== */
const State = {
  screen: "splash",    // splash | tutorial | login | office | trial | report
  mode: null,          // "career" | "study"
  player: null,        // {nome, idade, estado, cidade}
  cases: [],
  areaAtual: "criminal", // criminal | familia | trabalhista | stj
  fila: [],
  julgando: null,
  stats: {
    julgadosTotal: 0,
    julgadosCriminal: 0,
    julgadosFamilia: 0,
    julgadosTrabalhista: 0,
    julgadosStj: 0,
    acertosCriminal: 0,
    prestigio: 0
  },
  history: [],        // {ts, modo, area, idCaso, titulo, decisao, acertou}
  soundsOn: true,
  ultimoTextoPergunta: "",
  lastExposicaoAcus: "",
  lastExposicaoDef: "",
  lastResposta: "",
  stjAtivo: false,
  juri: []            // {id, voto, certeza}
};

/* ==========================
   HELPERS
   ========================== */

function play(id, vol = 0.9) {
  try {
    const el = document.querySelector(id);
    if (!el || !State.soundsOn) return;
    el.currentTime = 0;
    el.volume = vol;
    el.play();
  } catch(e) {}
}

function startAmbience() {
  if (!State.soundsOn) return;
  const amb = document.querySelector("#s-amb");
  try { amb.volume = 0.4; amb.play(); } catch(e) {}
}
function stopAmbience() {
  const amb = document.querySelector("#s-amb");
  try { amb.pause(); } catch(e) {}
}

function stripAccents(str) {
  return str.normalize("NFD").replace(/[\u0300-\u036f]/g,"");
}

/* ==========================
   EFEITO TYPEWRITER
   ========================== */

function typewriterText(elementId, fullText, speed = 18) {
  const el = document.getElementById(elementId);
  if (!el) return;
  el.textContent = "";
  let i = 0;
  const interval = setInterval(() => {
    if (i >= fullText.length) {
      clearInterval(interval);
      return;
    }
    el.textContent += fullText.charAt(i);
    i++;
  }, speed);
}

/* ==========================
   SAVE / LOAD CARREIRA
   ========================== */

const STORAGE_KEY = "juizSim_carreira_v40";

function saveCareer(auto = true) {
  if (State.mode !== "career") return;
  const payload = {
    player: State.player,
    stats: State.stats,
    history: State.history,
    stjAtivo: State.stjAtivo
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
  if (!auto) alert("Progresso salvo com sucesso neste navegador.");
}

function loadCareer() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) return false;
  try {
    const data = JSON.parse(raw);
    State.player = data.player || null;
    State.stats = data.stats || State.stats;
    State.history = data.history || [];
    State.stjAtivo = !!data.stjAtivo;
    return true;
  } catch(e) {
    console.error(e);
    return false;
  }
}

function exportSave() {
  const payload = {
    player: State.player,
    stats: State.stats,
    history: State.history,
    stjAtivo: State.stjAtivo
  };
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "juizSim_save.json";
  a.click();
  URL.revokeObjectURL(url);
}

function importSave(file) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    try {
      const data = JSON.parse(reader.result);
      State.player = data.player || null;
      State.stats = data.stats || State.stats;
      State.history = data.history || [];
      State.stjAtivo = !!data.stjAtivo;
      alert("Save importado com sucesso!");
      if (State.player) {
        State.mode = "career";
        State.screen = "office";
        montarFila();
      }
      render();
    } catch(e) {
      alert("Arquivo inv√°lido.");
    }
  };
  reader.readAsText(file);
}

/* ==========================
   SEED DE CASOS ‚Äì 100 POR √ÅREA + 100 STJ
   ========================== */

function seedCases() {
  const casos = [];

  const ricosCriminal = [
    {
      titulo: "Homic√≠dio simples em bar de bairro",
      resumo: "Discuss√£o em bar de periferia, na madrugada de s√°bado. R√©u alega leg√≠tima defesa ap√≥s ser empurrado e insultado.",
      gabarito: {
        culpado: true,
        padrao: "alem_duvida",
        explicacao:
          "O conjunto probat√≥rio (laudo, depoimentos e imagens) aponta para excesso na rea√ß√£o do r√©u: mesmo ap√≥s cessado o perigo imediato, ele prosseguiu com golpes fatais. A leg√≠tima defesa se descaracteriza, permitindo condena√ß√£o al√©m de d√∫vida razo√°vel."
      },
      provas: [
        {
          id: "E1",
          tipo: "boletim de ocorr√™ncia",
          conteudo: "Registro policial descreve agress√µes m√∫tuas, mas destaca que a v√≠tima estava desarmada no momento do golpe fatal."
        },
        {
          id: "E2",
          tipo: "laudo pericial",
          conteudo: "Exame de corpo de delito indica m√∫ltiplas perfura√ß√µes, compat√≠veis com golpe repetido de faca."
        },
        {
          id: "E3",
          tipo: "depoimento de testemunha",
          conteudo: "Gar√ßom afirma que a briga foi separada e, ap√≥s alguns segundos, o r√©u voltou e golpeou a v√≠tima."
        },
        {
          id: "E4",
          tipo: "imagens de c√¢mera",
          conteudo: "C√¢meras mostram a v√≠tima tentando se afastar, com m√£os para cima, antes de ser atingida."
        }
      ]
    },
    {
      titulo: "Roubo majorado com emprego de arma de fogo",
      resumo: "Assalto a transeunte em via p√∫blica. V√≠tima reconhece o r√©u e descreve uso de arma de fogo.",
      gabarito: {
        culpado: true,
        padrao: "alem_duvida",
        explicacao:
          "A materialidade do fato e a autoria se confirmam por reconhecimento firme, apreens√£o de bens da v√≠tima com o r√©u e relatos coerentes. A majorante de arma √© mantida diante da descri√ß√£o segura, mesmo sem apreens√£o do armamento."
      },
      provas: [
        {
          id: "E1",
          tipo: "boletim de ocorr√™ncia",
          conteudo: "V√≠tima narra subtra√ß√£o de celular e carteira sob mira de arma de fogo."
        },
        {
          id: "E2",
          tipo: "auto de apreens√£o",
          conteudo: "Com o r√©u foram encontrados o aparelho celular e a carteira da v√≠tima, poucos minutos ap√≥s o fato."
        },
        {
          id: "E3",
          tipo: "depoimento de v√≠tima",
          conteudo: "V√≠tima indica caracter√≠sticas f√≠sicas do assaltante e tatuagem espec√≠fica no antebra√ßo, compat√≠vel com o r√©u."
        }
      ]
    },
    {
      titulo: "Les√£o corporal em contexto de viol√™ncia dom√©stica",
      resumo: "Companheira apresenta hematomas recentes e relata agress√µes reiteradas dentro de casa. R√©u nega e fala em 'acidente dom√©stico'.",
      gabarito: {
        culpado: true,
        padrao: "alem_duvida",
        explicacao:
          "A palavra da v√≠tima, em contexto de viol√™ncia dom√©stica, recebe especial relevo e est√° corroborada por laudo m√©dico e relatos de vizinhos sobre brigas anteriores."
      },
      provas: [
        {
          id: "E1",
          tipo: "laudo m√©dico",
          conteudo: "Exame de corpo de delito indica hematomas em regi√µes t√≠picas de defesa, com diferentes est√°gios de cicatriza√ß√£o."
        },
        {
          id: "E2",
          tipo: "depoimento de v√≠tima",
          conteudo: "Relata epis√≥dios anteriores de agress√£o e amea√ßa de morte, inclusive frente aos filhos."
        },
        {
          id: "E3",
          tipo: "depoimento de vizinho",
          conteudo: "Vizinhos afirmam ouvir discuss√µes frequentes, com pedidos de socorro vindos do apartamento."
        }
      ]
    },
    {
      titulo: "Tr√°fico de drogas em via p√∫blica",
      resumo: "R√©u √© abordado com por√ß√µes fracionadas e quantia em dinheiro trocado. Defesa alega uso pr√≥prio.",
      gabarito: {
        culpado: true,
        padrao: "alem_duvida",
        explicacao:
          "A quantidade, forma de acondicionamento e apreens√£o de valores trocados, aliadas √† aus√™ncia de elementos de uso pessoal, indicam finalidade mercantil."
      },
      provas: [
        {
          id: "E1",
          tipo: "auto de apreens√£o",
          conteudo: "18 por√ß√µes de crack embaladas individualmente, al√©m de R$ 247,00 em c√©dulas de baixo valor."
        },
        {
          id: "E2",
          tipo: "laudo toxicol√≥gico",
          conteudo: "Constata presen√ßa de subst√¢ncia entorpecente em todas as por√ß√µes."
        },
        {
          id: "E3",
          tipo: "depoimento de policial",
          conteudo: "Narra que o r√©u era observado realizando r√°pidas trocas com transeuntes antes da abordagem."
        }
      ]
    }
  ];

  const ricosFamilia = [
    {
      titulo: "Guarda compartilhada com resid√™ncia fixa discutida",
      resumo: "Pais concordam com guarda compartilhada, mas divergem sobre cidade de resid√™ncia da crian√ßa ap√≥s proposta de mudan√ßa.",
      gabarito: {
        culpado: false,
        padrao: "preponderancia",
        explicacao:
          "A decis√£o deve priorizar o melhor interesse da crian√ßa, avaliando v√≠nculos afetivos, rotina escolar e rede de apoio."
      },
      provas: [
        {
          id: "F1",
          tipo: "relat√≥rio psicossocial",
          conteudo: "Equipe t√©cnica descreve forte v√≠nculo da crian√ßa com a escola atual e com av√≥s maternos."
        },
        {
          id: "F2",
          tipo: "hist√≥rico escolar",
          conteudo: "Boletins indicam adapta√ß√£o positiva e bom desempenho na escola atual."
        }
      ]
    },
    {
      titulo: "Revis√£o de pens√£o aliment√≠cia ap√≥s desemprego",
      resumo: "Alimentante perde emprego formal e alega impossibilidade de manter o mesmo valor de pens√£o.",
      gabarito: {
        culpado: false,
        padrao: "preponderancia",
        explicacao:
          "O bin√¥mio necessidade/possibilidade deve ser reequilibrado. A queda dr√°stica da renda justifica revis√£o, mas n√£o supress√£o da pens√£o."
      },
      provas: [
        {
          id: "F1",
          tipo: "CTPS / rescis√£o",
          conteudo: "Documentos comprovam rescis√£o recente e aus√™ncia de novo v√≠nculo."
        },
        {
          id: "F2",
          tipo: "extratos banc√°rios",
          conteudo: "Mostram redu√ß√£o acentuada das entradas mensais, sem movimenta√ß√µes compat√≠veis com renda alta informal."
        }
      ]
    },
    {
      titulo: "Regulamenta√ß√£o de visitas com hist√≥rico de atrasos",
      resumo: "Genitor n√£o guardi√£o deseja ampliar conv√≠vio, mesmo apresentando hist√≥rico de atrasos e faltas nas visitas.",
      gabarito: {
        culpado: false,
        padrao: "preponderancia",
        explicacao:
          "O v√≠nculo da crian√ßa com o genitor deve ser preservado, mas o hist√≥rico autoriza visitas progressivas e advert√™ncia formal."
      },
      provas: [
        {
          id: "F1",
          tipo: "relat√≥rio psicol√≥gico",
          conteudo: "A crian√ßa sente frustra√ß√£o quando as visitas s√£o canceladas na √∫ltima hora."
        },
        {
          id: "F2",
          tipo: "mensagens",
          conteudo: "Conversas registram justificativas repetidas de 'imprevistos de trabalho' e pedidos de remarca√ß√£o."
        }
      ]
    }
  ];

  const ricosTrabalhista = [
    {
      titulo: "Horas extras habituais sem registro",
      resumo: "Empregado afirma trabalhar 2 horas al√©m do expediente, diariamente, sem lan√ßamento correto em cart√£o de ponto.",
      gabarito: {
        culpado: false,
        padrao: "preponderancia",
        explicacao:
          "Marca√ß√µes invari√°veis de ponto e testemunho que confirma extrapola√ß√µes indicam verossimilhan√ßa do pedido de horas extras."
      },
      provas: [
        {
          id: "T1",
          tipo: "cart√£o de ponto",
          conteudo: "Registros com hor√°rios 'fechados', sugerindo marca√ß√£o brit√¢nica."
        },
        {
          id: "T2",
          tipo: "testemunha colega",
          conteudo: "Afirma que quase todos sa√≠am ap√≥s o hor√°rio, mas registravam a sa√≠da no hor√°rio contratual."
        }
      ]
    },
    {
      titulo: "V√≠nculo de emprego disfar√ßado sob PJ",
      resumo: "Trabalhador atuou 3 anos emitindo notas fiscais mensais, mas alega subordina√ß√£o, pessoalidade e habitualidade.",
      gabarito: {
        culpado: false,
        padrao: "preponderancia",
        explicacao:
          "Elementos t√≠picos de rela√ß√£o empregat√≠cia (exclusividade, ordens diretas, controle de jornada) indicam fraude na contrata√ß√£o PJ."
      },
      provas: [
        {
          id: "T1",
          tipo: "contrato de presta√ß√£o de servi√ßos",
          conteudo: "Prev√™ exclusividade de atua√ß√£o e cumprimento de metas internas."
        },
        {
          id: "T2",
          tipo: "emails corporativos",
          conteudo: "Demonstram controle de hor√°rio e aplica√ß√£o de advert√™ncias como se empregado fosse."
        }
      ]
    },
    {
      titulo: "Ass√©dio moral por humilha√ß√µes p√∫blicas",
      resumo: "Empregado relata broncas frequentes em p√∫blico e apelidos pejorativos dados pelo superior.",
      gabarito: {
        culpado: false,
        padrao: "preponderancia",
        explicacao:
          "A reitera√ß√£o de condutas humilhantes, confirmada por testemunhas e mensagens, excede o poder diretivo do empregador."
      },
      provas: [
        {
          id: "T1",
          tipo: "mensagens em grupo",
          conteudo: "Prints mostram xingamentos e chacotas sobre o desempenho do autor."
        },
        {
          id: "T2",
          tipo: "testemunha ex-colega",
          conteudo: "Confirma que as broncas eram feitas em voz alta, na frente de toda a equipe."
        }
      ]
    }
  ];

  function geraAutoCriminal(i) {
    const armas = ["faca", "arma de fogo", "garrafa quebrada", "simulacro de arma", "pau de madeira"];
    const locais = ["em bar de esquina", "em frente a um mercado", "em baile de comunidade", "em ponto de √¥nibus", "em rua pouco iluminada"];
    const vitimas = ["v√≠tima desconhecida", "vizinho", "colega de trabalho", "companheiro(a)", "cliente"];
    const arma = armas[i % armas.length];
    const local = locais[i % locais.length];
    const vit = vitimas[i % vitimas.length];

    const titulo = `Delito em contexto de discuss√£o ${local}`;
    const resumo = `Desentendimento pr√©vio culmina em agress√£o com uso de ${arma}, tendo como alvo ${vit}. H√° vers√µes divergentes sobre quem iniciou o conflito.`;

    const gabarito = {
      culpado: true,
      padrao: "alem_duvida",
      explicacao:
        "Apesar das diverg√™ncias pontuais, a converg√™ncia quanto √† autoria e ao modo de execu√ß√£o sustenta condena√ß√£o al√©m de d√∫vida razo√°vel."
    };

    const provas = [
      {
        id: "E1",
        tipo: "boletim de ocorr√™ncia",
        conteudo: `Relata que a agress√£o ocorreu ${local}, ap√≥s discuss√£o iniciada por motivo banal.`
      },
      {
        id: "E2",
        tipo: "laudo pericial",
        conteudo: `Indica les√µes compat√≠veis com uso de ${arma}, com risco √† integridade da v√≠tima.`
      },
      {
        id: "E3",
        tipo: "depoimento de testemunha",
        conteudo: "Testemunha afirma ter visto o r√©u em posse do objeto antes da agress√£o."
      }
    ];

    return { id: `C${String(i + 1).padStart(3, "0")}`, tipo: "criminal", titulo, resumo, gabarito, provas, status: "na_fila" };
  }

  function geraAutoFamilia(i) {
    const temas = [
      "amplia√ß√£o de visitas",
      "redu√ß√£o de pens√£o",
      "altera√ß√£o de guarda",
      "defini√ß√£o de f√©rias escolares",
      "autoriza√ß√£o para mudan√ßa de cidade"
    ];
    const tema = temas[i % temas.length];

    const titulo = `Conflito familiar sobre ${tema}`;
    const resumo = `Genitores divergem quanto √† ${tema}, com hist√≥rico recente de comunica√ß√£o tensa, mas ambos demonstram v√≠nculo afetivo com a crian√ßa.`;

    const gabarito = {
      culpado: false,
      padrao: "preponderancia",
      explicacao:
        "A solu√ß√£o deve privilegiar o melhor interesse da crian√ßa, preservando v√≠nculos afetivos, rotina est√°vel e participa√ß√£o equilibrada dos genitores."
    };

    const provas = [
      {
        id: "F1",
        tipo: "relat√≥rio psicossocial",
        conteudo: "Aponta la√ßos afetivos preservados, mas identifica impactos emocionais devido a conflitos entre os pais."
      },
      {
        id: "F2",
        tipo: "mensagens",
        conteudo: "Mostram discuss√µes sobre hor√°rios, atrasos e flexibiliza√ß√£o de finais de semana."
      }
    ];

    return { id: `F${String(i + 1).padStart(3, "0")}`, tipo: "familia", titulo, resumo, gabarito, provas, status: "na_fila" };
  }

  function geraAutoTrabalhista(i) {
    const temas = [
      "pagamento de adicional de insalubridade",
      "intervalo intrajornada suprimido",
      "equipara√ß√£o salarial",
      "ac√∫mulo de fun√ß√µes",
      "acidente de trabalho sem CAT"
    ];
    const setor = ["supermercado", "hospital", "call center", "ind√∫stria", "log√≠stica"][i % 5];
    const tema = temas[i % temas.length];

    const titulo = `Discuss√£o trabalhista sobre ${tema} em empresa do ramo de ${setor}`;
    const resumo = `Empregado alega irregularidades relativas a ${tema} em empresa do ramo de ${setor}. A empresa nega e cita normas internas de compliance.`;

    const gabarito = {
      culpado: false,
      padrao: "preponderancia",
      explicacao:
        "A an√°lise recai sobre a prova produzida (documental e testemunhal) e sobre a coer√™ncia da narrativa do trabalhador."
    };

    const provas = [
      {
        id: "T1",
        tipo: "documentos internos",
        conteudo: "Regulamentos e fichas de EPI/treinamento, nem sempre assinados na pr√°tica."
      },
      {
        id: "T2",
        tipo: "testemunha colega",
        conteudo: "Relata como de fato ocorria a rotina di√°ria no setor de trabalho do autor."
      }
    ];

    return { id: `T${String(i + 1).padStart(3, "0")}`, tipo: "trabalhista", titulo, resumo, gabarito, provas, status: "na_fila" };
  }

  const alvoPorArea = 100;

  // Criminal
  ricosCriminal.forEach((c, idx) => {
    casos.push({
      id: `C${String(idx + 1).padStart(3, "0")}`,
      tipo: "criminal",
      titulo: c.titulo,
      resumo: c.resumo,
      gabarito: c.gabarito,
      provas: c.provas,
      status: "na_fila"
    });
  });
  for (let i = ricosCriminal.length; i < alvoPorArea; i++) {
    casos.push(geraAutoCriminal(i));
  }

  // Fam√≠lia
  ricosFamilia.forEach((c, idx) => {
    casos.push({
      id: `F${String(idx + 1).padStart(3, "0")}`,
      tipo: "familia",
      titulo: c.titulo,
      resumo: c.resumo,
      gabarito: c.gabarito,
      provas: c.provas,
      status: "na_fila"
    });
  });
  for (let i = ricosFamilia.length; i < alvoPorArea; i++) {
    casos.push(geraAutoFamilia(i));
  }

  // Trabalhista
  ricosTrabalhista.forEach((c, idx) => {
    casos.push({
      id: `T${String(idx + 1).padStart(3, "0")}`,
      tipo: "trabalhista",
      titulo: c.titulo,
      resumo: c.resumo,
      gabarito: c.gabarito,
      provas: c.provas,
      status: "na_fila"
    });
  });
  for (let i = ricosTrabalhista.length; i < alvoPorArea; i++) {
    casos.push(geraAutoTrabalhista(i));
  }

  // STJ: 100 recursos sobre casos das tr√™s √°reas
  const baseParaStj = casos.filter(c => ["criminal","familia","trabalhista"].includes(c.tipo));
  for (let i = 0; i < 100; i++) {
    const origem = baseParaStj[i % baseParaStj.length];
    casos.push({
      id: `S${String(i + 1).padStart(3, "0")}`,
      tipo: "stj",
      ramo: origem.tipo,
      titulo: `Recurso especial no STJ sobre: ${origem.titulo}`,
      resumo: `Recurso contra ac√≥rd√£o de tribunal local que manteve decis√£o em caso de ${origem.titulo}. Discute-se aplica√ß√£o correta da lei federal.`,
      gabarito: {
        culpado: origem.gabarito.culpado,
        padrao: origem.gabarito.padrao,
        explicacao:
          "No STJ, o foco recai sobre a correta interpreta√ß√£o da lei federal, n√£o reexame amplo de provas."
      },
      provas: origem.provas,
      status: "na_fila"
    });
  }

  return casos;
}

/* ==========================
   IA LOCAL ‚Äì EXPOSI√á√ÉO E PERGUNTAS
   ========================== */

function iaExposicaoInicial(lado, caso) {
  const cab = lado === "acusacao" ? "ACUSA√á√ÉO" : "DEFESA";
  const ids = caso.provas.map(p => `[${p.id}] ${p.tipo}`).join(", ");

  let corpo;
  if (lado === "acusacao") {
    if (caso.tipo === "criminal" || caso.ramo === "criminal") {
      corpo =
        "o conjunto probat√≥rio revela autoria e materialidade consistentes, superando o patamar do 'al√©m de d√∫vida razo√°vel', sem sinais relevantes de fabrica√ß√£o ou colus√£o.";
    } else {
      corpo =
        "os elementos constantes dos autos favorecem a proced√™ncia da pretens√£o inicial, especialmente pela coer√™ncia documental e converg√™ncia dos depoimentos.";
    }
  } else {
    if (caso.tipo === "criminal" || caso.ramo === "criminal") {
      corpo =
        "apesar da gravidade dos fatos narrados, as lacunas e contradi√ß√µes da prova impedem uma condena√ß√£o segura, impondo aplica√ß√£o do in dubio pro reo.";
    } else {
      corpo =
        "a parte contr√°ria n√£o se desincumbiu integralmente do √¥nus que lhe cabia, e a narrativa da parte autora/reclamante mostra-se, no m√≠nimo, t√£o cr√≠vel quanto a vers√£o adversa.";
    }
  }

  return `${cab} ‚Äî exposi√ß√£o inicial:\n\nUtilizando, sobretudo, os elementos ${ids}, ${corpo}\n\nRequer-se que essa leitura seja considerada na forma√ß√£o do convencimento deste Ju√≠zo.`;
}

function analisarPergunta(pergunta, caso, lado, contextoUlt) {
  const original = pergunta.trim();
  let q = stripAccents(original.toLowerCase());

  const ids = [];
  const reDoc = /\b(e\d{1,2}|f\d{1,2}|t\d{1,2})\b/gi;
  let m;
  while ((m = reDoc.exec(original))) {
    ids.push(m[1].toUpperCase());
  }
  const docs = ids
    .map(id => caso.provas.find(p => p.id === id))
    .filter(Boolean);

  const map = {
    laudo: caso.provas.find(p => p.tipo.toLowerCase().includes("laudo") || p.tipo.toLowerCase().includes("ppp")),
    boletim: caso.provas.find(p => p.tipo.toLowerCase().includes("boletim")),
    test: caso.provas.find(p => p.tipo.toLowerCase().includes("testemunha") || p.tipo.toLowerCase().includes("vizin")),
    cam: caso.provas.find(p => p.tipo.toLowerCase().includes("c√¢mera") || p.tipo.toLowerCase().includes("imagem")),
    msg: caso.provas.find(p => p.tipo.toLowerCase().includes("mensagens") || p.tipo.toLowerCase().includes("prints")),
    ponto: caso.provas.find(p => p.tipo.toLowerCase().includes("cart√£o"))
  };

  let foco = null, temaExtra = "";

  if (docs.length) foco = docs[0];
  else if (q.match(/laudo|peric/ ) && map.laudo) foco = map.laudo;
  else if (q.match(/boletim|b\.o|bo /) && map.boletim) foco = map.boletim;
  else if (q.match(/testemunh|vizinh|colega/) && map.test) foco = map.test;
  else if (q.match(/camera|video|imagem/) && map.cam) foco = map.cam;
  else if (q.match(/mensagen|whats|print|grupo/) && map.msg) foco = map.msg;
  else if (q.match(/ponto|jornada|horas/) && map.ponto) foco = map.ponto;

  if (q.match(/prisao|preventiv|cautelar|soltura|liberdade/)) {
    temaExtra =
      lado === "acusacao"
        ? "Em rela√ß√£o √† pris√£o cautelar, avaliando gravidade concreta e risco de reitera√ß√£o, entende-se presentes motivos para manuten√ß√£o da medida."
        : "Quanto √† pris√£o cautelar, a defesa sustenta que medidas diversas ‚Äî como monitoramento e proibi√ß√£o de contato ‚Äî seriam suficientes.";
  }

  if (q.match(/dolo|intencao|intenc[a√£]o|culpa/)) {
    temaExtra +=
      (temaExtra ? " " : "") +
      (lado === "acusacao"
        ? "Os elementos indicam atua√ß√£o consciente, com representa√ß√£o do resultado, o que afasta a tese de mera culpa."
        : "N√£o h√° demonstra√ß√£o segura de que o agente assumiu o risco do resultado, permitindo leitura compat√≠vel com modalidade culposa ou at√© aus√™ncia de responsabilidade.");
  }

  if (q.match(/contrad(ic|i[c√ß][a√£]o)|vers[ao]es diferentes|diverg/)) {
    temaExtra +=
      (temaExtra ? " " : "") +
      (lado === "acusacao"
        ? "As diverg√™ncias pontuais s√£o naturais e n√£o comprometem a espinha dorsal da narrativa acusat√≥ria."
        : "As contradi√ß√µes em pontos centrais fragilizam a acusa√ß√£o e devem pesar em favor da d√∫vida.");
  }

  if (q.match(/crian[c√ß]a|melhor interesse|guarda|visita/) && caso.tipo === "familia") {
    temaExtra +=
      (temaExtra ? " " : "") +
      "Nas demandas de fam√≠lia, o eixo decis√≥rio deve girar em torno do melhor interesse da crian√ßa, acima da conveni√™ncia dos adultos.";
  }

  if (q.match(/onus da prova|on[u√∫]s/)) {
    temaExtra +=
      (temaExtra ? " " : "") +
      (lado === "acusacao"
        ? "Relembra-se que, aqui, o √¥nus probat√≥rio recai predominantemente sobre a parte autora/acusadora, que entende ter se desincumbido de forma adequada."
        : "Pelo crit√©rio do √¥nus da prova, constata-se que a parte adversa n√£o trouxe elementos suficientes para superar a d√∫vida razo√°vel.");
  }

  const cabec = lado === "acusacao" ? "ACUSA√á√ÉO" : "DEFESA";
  let texto = `${cabec} ‚Äî resposta √† pergunta do juiz:\n\n‚Äú${original}‚Äù\n\n`;

  if (foco) {
    texto += `Tomando como refer√™ncia o documento ${foco.id} (${foco.tipo}), verifica-se que ${foco.conteudo.toLowerCase()}\n\n`;
  } else if (caso.provas.length) {
    const p0 = caso.provas[0];
    texto += `√Ä luz do conjunto probat√≥rio, especialmente o documento ${p0.id} (${p0.tipo}), extrai-se panorama relevante para o ponto questionado.\n\n`;
  }

  if (contextoUlt) {
    texto += `Considerando ainda o que j√° foi mencionado antes sobre ‚Äú${contextoUlt.slice(0, 80)}‚Ä¶‚Äù, `;
  }

  if (lado === "acusacao") {
    texto +=
      caso.tipo === "criminal" || caso.ramo === "criminal"
        ? "a leitura das provas converge para a responsabiliza√ß√£o do acusado, superando o patamar da d√∫vida razo√°vel."
        : "a coer√™ncia dos documentos e depoimentos respalda a tese da parte autora.";
  } else {
    texto +=
      caso.tipo === "criminal" || caso.ramo === "criminal"
        ? "as lacunas e inconsist√™ncias identificadas na prova recomendam prud√™ncia, inclinando o racioc√≠nio √† absolvi√ß√£o em homenagem ao in dubio pro reo."
        : "a parte contr√°ria n√£o afasta, de forma robusta, as alega√ß√µes do requerente, o que mant√©m plaus√≠vel sua vers√£o.";
  }

  if (temaExtra) texto += " " + temaExtra;

  texto += "\n\nEm s√≠ntese, Excel√™ncia, essa √© a compreens√£o jur√≠dica que submetemos ao crivo deste Ju√≠zo.";
  return texto;
}

/* ==========================
   FILA / √ÅREA / STJ
   ========================== */

function montarFila() {
  const area = State.areaAtual;
  State.fila = State.cases.filter(c => c.tipo === area);
  if (area === "stj" && !State.stjAtivo) {
    State.fila = [];
  }
}

/* ==========================
   VEREDITO + HIST√ìRICO
   ========================== */

function registrarVeredito(caso, culpado) {
  if (!caso) return;
  const isCriminal = caso.tipo === "criminal" || caso.ramo === "criminal";
  const acertou = isCriminal ? (culpado === !!caso.gabarito.culpado) : true;

  State.stats.julgadosTotal++;

  if (caso.tipo === "criminal") {
    State.stats.julgadosCriminal++;
    if (acertou) State.stats.acertosCriminal++;
  } else if (caso.tipo === "familia") {
    State.stats.julgadosFamilia++;
  } else if (caso.tipo === "trabalhista") {
    State.stats.julgadosTrabalhista++;
  } else if (caso.tipo === "stj") {
    State.stats.julgadosStj++;
  }

  const IAJ = State.stats.julgadosCriminal
    ? State.stats.acertosCriminal / State.stats.julgadosCriminal
    : 0;
  State.stats.prestigio = Math.min(100, Math.round(IAJ * 70 + Math.min(30, State.stats.julgadosTotal / 2)));

  State.history.push({
    ts: Date.now(),
    modo: State.mode,
    area: caso.tipo === "stj" ? "stj" : caso.tipo,
    idCaso: caso.id,
    titulo: caso.titulo,
    decisao: culpado ? "Condenou" : "Absolveu/Improcedente",
    acertou
  });

  // Convite para STJ
  if (!State.stjAtivo && State.stats.julgadosTotal >= 15 && IAJ >= 0.7) {
    State.stjAtivo = true;
    alert("Parab√©ns! Seu desempenho chamou aten√ß√£o. STJ desbloqueado no modo carreira.");
  }

  if (State.mode === "career") saveCareer(true);

  // Feedback pedag√≥gico
  let msg = "";
  if (isCriminal) {
    const acertouTxt = acertou ? "Sua decis√£o est√° alinhada com o gabarito sugerido para o caso." : "Sua decis√£o diverge do gabarito sugerido para este caso.";
    msg += acertouTxt + "\n\n";
    if (caso.gabarito && caso.gabarito.explicacao) {
      msg += "Justificativa sugerida:\n" + caso.gabarito.explicacao;
    } else {
      msg += "Sugest√£o: avalie novamente a coer√™ncia entre laudos, depoimentos e a necessidade de superar a d√∫vida razo√°vel para condenar.";
    }
  } else {
    msg += "Neste tipo de demanda (fam√≠lia/trabalho/STJ), o mais importante √© a fundamenta√ß√£o equilibrada, ponderando necessidade, possibilidade e provas dispon√≠veis.\n\n";
    if (caso.gabarito && caso.gabarito.explicacao) {
      msg += "Coment√°rio sugerido:\n" + caso.gabarito.explicacao;
    }
  }
  alert(msg);
}

/* ==========================
   J√öRI POPULAR SIMULADO
   ========================== */

function initJuri(caso) {
  State.juri = Array.from({length:12}, (_,i)=>({id:i+1, voto:null, certeza:0}));
}

function simularJuri() {
  const caso = State.julgando;
  if (!caso) return;
  const culpGabarito = !!(caso.gabarito && caso.gabarito.culpado);
  State.juri = State.juri.map(j => {
    let voto, certeza;
    if (caso.tipo === "criminal" || caso.ramo === "criminal") {
      if (culpGabarito) {
        voto = Math.random() < 0.7; // maioria tende √† condena√ß√£o
      } else {
        voto = Math.random() < 0.35; // maioria tende √† absolvi√ß√£o
      }
      certeza = Math.round(40 + Math.random()*50);
    } else {
      voto = Math.random() < 0.55;
      certeza = Math.round(30 + Math.random()*60);
    }
    return {...j, voto, certeza};
  });
  play("#s-murmur",0.4);
  render();
}

/* ==========================
   RENDERIZA√á√ÉO DAS TELAS
   ========================== */

function renderSplash() {
  return `
  <div class="min-h-screen bg-court relative">
    <div class="absolute inset-0 bg-gradient-to-b from-black/80 via-black/60 to-black/90"></div>
    <div class="relative max-w-5xl mx-auto px-4 py-8 flex flex-col gap-10">
      <header class="flex items-center justify-between text-sm text-slate-300">
        <div>
          <div class="uppercase tracking-[0.25em] text-xs text-emerald-300/80">Vale Produ√ß√£o</div>
          <div class="font-semibold text-slate-100">Simulador Jur√≠dico</div>
        </div>
        <button class="btn-soft" onclick="toggleSound()">
          ${State.soundsOn ? "üîä Sons ON" : "üîá Sons OFF"}
        </button>
      </header>

      <main class="flex-1 grid lg:grid-cols-[2fr,1.2fr] gap-8 items-center">
        <div>
          <h1 class="text-4xl md:text-5xl font-extrabold text-white tracking-tight">
            Jogo do Juiz <span class="text-emerald-400">4.0</span>
          </h1>
          <p class="mt-4 text-slate-300 max-w-xl">
            Entre na pele de um juiz brasileiro, julgue casos simulados em
            <span class="text-emerald-300">Direito Penal, Fam√≠lia, Trabalho e STJ</span>.
            Treine sua fundamenta√ß√£o, veja feedback jur√≠dico e acompanhe seu desempenho.
          </p>

          <div class="mt-8 flex flex-wrap gap-3">
            <button class="btn-main" onclick="irModo('career')">
              üéØ Iniciar Modo Carreira
            </button>
            <button class="btn-soft" onclick="irModo('study')">
              üìö Iniciar Modo Estudo
            </button>
            <button class="btn-soft" onclick="State.screen='tutorial'; render();">
              ‚ùì Como salvar meu progresso
            </button>
          </div>

          <div class="mt-6 text-xs text-slate-400 space-y-1">
            <p>‚Ä¢ Modo Carreira: salva automaticamente neste navegador e desbloqueia STJ.</p>
            <p>‚Ä¢ Modo Estudo: ideal para faculdades, cursinhos e simulados r√°pidos.</p>
          </div>
        </div>

        <div class="glass rounded-3xl p-6 border border-emerald-400/20 shadow-xl">
          <h2 class="text-lg font-semibold text-emerald-300 mb-3">Carregar progresso</h2>
          <p class="text-xs text-slate-300 mb-4">
            Se voc√™ j√° jogou neste navegador, pode retomar sua carreira do ponto em que parou.
          </p>
          <button class="btn-soft w-full mb-4" onclick="carregarLocal()">üîÅ Carregar deste navegador</button>
          <div class="text-xs text-slate-300 mb-1">Ou importe um arquivo de save (.json):</div>
          <input type="file" accept="application/json" class="w-full text-xs bg-white/5 rounded-lg p-2"
                 onchange="importSave(this.files[0])" />
        </div>
      </main>

      <footer class="text-[11px] text-slate-500">
        Vers√£o 4.0 ‚Äì Simula√ß√£o educacional. N√£o substitui aconselhamento jur√≠dico profissional.
      </footer>
    </div>
  </div>`;
}

function renderTutorial() {
  return `
  <div class="min-h-screen bg-office relative">
    <div class="absolute inset-0 bg-gradient-to-b from-black/80 via-black/70 to-black/90"></div>
    <div class="relative max-w-4xl mx-auto px-4 py-8">
      <button class="btn-soft mb-6" onclick="State.screen='splash'; render();">‚Üê Voltar</button>

      <div class="glass rounded-3xl p-6 border border-white/10 space-y-4">
        <h2 class="text-2xl font-bold text-white">Como funciona o salvamento?</h2>
        <p class="text-slate-300 text-sm">
          No <span class="font-semibold text-emerald-300">Modo Carreira</span>, o jogo salva automaticamente
          seu progresso neste navegador, usando a mem√≥ria local do seu dispositivo (localStorage).
        </p>

        <ol class="list-decimal list-inside text-sm text-slate-200 space-y-2">
          <li>Ao terminar cada julgamento no modo carreira, o progresso √© salvo automaticamente.</li>
          <li>Voc√™ pode, a qualquer momento, clicar em <span class="text-emerald-300">"Exportar save"</span> para gerar um arquivo .json.</li>
          <li>Guarde esse arquivo. Com ele, √© poss√≠vel importar seu progresso em outro navegador ou computador.</li>
          <li>Para importar, basta usar o bot√£o <span class="text-emerald-300">"Importar save (.json)"</span> na tela inicial ou no escrit√≥rio.</li>
        </ol>

        <p class="text-xs text-slate-400 mt-3">
          Importante: o <span class="font-semibold">Modo Estudo</span> n√£o altera sua carreira: ele √© ideal para simulados
          e aulas, pois n√£o impacta as estat√≠sticas oficiais da sua trajet√≥ria.
        </p>
      </div>
    </div>
  </div>`;
}

function renderLogin() {
  const nome = State.player?.nome || "";
  const idade = State.player?.idade || "";
  const estado = State.player?.estado || "SP";
  const cidade = State.player?.cidade || "S√£o Paulo";

  return `
  <div class="min-h-screen bg-office relative">
    <div class="absolute inset-0 bg-gradient-to-b from-black/80 via-black/70 to-black/90"></div>
    <div class="relative max-w-3xl mx-auto px-4 py-8">
      <button class="btn-soft mb-6" onclick="State.screen='splash'; render();">‚Üê Voltar</button>

      <div class="glass rounded-3xl p-6 border border-emerald-400/20">
        <h2 class="text-2xl font-bold text-white mb-2">
          ${State.mode === "career" ? "Criar perfil de Juiz(a)" : "Configurar sess√£o de estudo"}
        </h2>
        <p class="text-sm text-slate-300 mb-4">
          Informe seus dados b√°sicos. Isso ser√° usado apenas dentro do simulador, para fins de imers√£o.
        </p>

        <div class="grid md:grid-cols-2 gap-4 text-sm">
          <div>
            <label class="text-slate-300 text-xs">Nome completo</label>
            <input id="inpNome" class="w-full mt-1 rounded-lg bg-white/10 px-3 py-2 outline-none"
                   value="${nome.replace(/"/g,"&quot;")}" placeholder="Ex.: Dra. Maria Alves" />
          </div>
          <div>
            <label class="text-slate-300 text-xs">Idade</label>
            <input id="inpIdade" type="number" class="w-full mt-1 rounded-lg bg-white/10 px-3 py-2 outline-none"
                   value="${idade}" placeholder="Ex.: 35" />
          </div>
          <div>
            <label class="text-slate-300 text-xs">Estado (UF)</label>
            <input id="inpEstado" class="w-full mt-1 rounded-lg bg-white/10 px-3 py-2 outline-none"
                   value="${estado}" placeholder="Ex.: SP" />
          </div>
          <div>
            <label class="text-slate-300 text-xs">Cidade</label>
            <input id="inpCidade" class="w-full mt-1 rounded-lg bg-white/10 px-3 py-2 outline-none"
                   value="${cidade.replace(/"/g,"&quot;")}" placeholder="Ex.: S√£o Paulo" />
          </div>
        </div>

        <p class="text-xs text-slate-400 mt-4">
          Voc√™ poder√° escolher o ramo (Criminal, Fam√≠lia, Trabalho e, depois, STJ) j√° no seu escrit√≥rio.
        </p>

        <div class="mt-6 flex justify-end gap-3">
          <button class="btn-soft" onclick="State.screen='splash'; render();">Cancelar</button>
          <button class="btn-main" onclick="confirmarLogin()">Continuar</button>
        </div>
      </div>
    </div>
  </div>`;
}

function renderOffice() {
  const p = State.player || {nome:"Juiz(a)", estado:"--", cidade:"--"};
  const IAJ = State.stats.julgadosCriminal
    ? (State.stats.acertosCriminal / State.stats.julgadosCriminal) * 100
    : 0;

  const areas = [
    {id:"criminal", nome:"Criminal", desc:"Crimes contra a pessoa, patrim√¥nio e viol√™ncia dom√©stica."},
    {id:"familia", nome:"Fam√≠lia", desc:"Guarda, pens√£o, visitas, melhor interesse da crian√ßa."},
    {id:"trabalhista", nome:"Trabalhista", desc:"V√≠nculo, verbas rescis√≥rias, horas extras, ass√©dio."}
  ];
  if (State.stjAtivo) {
    areas.push({id:"stj", nome:"STJ", desc:"Recursos especiais focados na lei federal."});
  }

  const filaHtml = State.fila.slice(0,8).map(c=>`
    <div class="rounded-xl bg-white/5 p-3 flex flex-col gap-1">
      <div class="text-xs uppercase tracking-wide text-emerald-300/80">${c.tipo === "stj" ? "STJ" : c.tipo.toUpperCase()}</div>
      <div class="text-sm font-semibold">${c.titulo}</div>
      <div class="text-[11px] text-slate-300 line-clamp-2">${c.resumo}</div>
      <div class="flex gap-2 mt-2">
        <button class="btn-soft text-[11px]" onclick="verCaso('${c.id}')">Ver processo</button>
        <button class="btn-main text-[11px]" onclick="iniciarJulgamento('${c.id}')">Iniciar julgamento</button>
      </div>
    </div>
  `).join("") || `<div class="text-xs text-slate-400">Nenhum processo na fila desta √°rea no momento.</div>`;

  return `
  <div class="min-h-screen bg-office relative">
    <div class="absolute inset-0 bg-gradient-to-b from-black/85 via-black/70 to-black/90"></div>
    <div class="relative max-w-6xl mx-auto px-4 py-6 space-y-4">
      <header class="flex flex-wrap items-center justify-between gap-4">
        <div>
          <div class="text-sm text-slate-300">Escrit√≥rio de ${State.mode === "career" ? "Carreira" : "Estudo"}</div>
          <h1 class="text-2xl font-bold text-white">${p.nome || "Juiz(a)"} ‚Ä¢ ${p.cidade || "--"}/${p.estado || "--"}</h1>
          <div class="text-[11px] text-slate-400">
            Casos julgados: ${State.stats.julgadosTotal} ‚Ä¢ Prest√≠gio: ${State.stats.prestigio}% ‚Ä¢ IAJ (Criminal): ${IAJ.toFixed(0)}%
          </div>
        </div>
        <div class="flex flex-wrap gap-2 text-xs">
          <button class="btn-soft" onclick="toggleSound()">
            ${State.soundsOn ? "üîä Sons ON" : "üîá Sons OFF"}
          </button>
          ${
            State.mode === "career"
              ? `<button class="btn-soft" onclick="saveCareer(false)">üíæ Salvar agora</button>
                 <button class="btn-soft" onclick="exportSave()">‚¨áÔ∏è Exportar save</button>`
              : ""
          }
          <button class="btn-soft" onclick="State.screen='report'; render();">üìä Relat√≥rio</button>
          <button class="btn-soft" onclick="State.screen='splash'; render();">‚èπ Sair</button>
        </div>
      </header>

      <section class="grid md:grid-cols-[1.1fr,1fr] gap-4">
        <div class="glass rounded-3xl p-4 border border-white/10">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-sm font-semibold text-slate-100">Fila de processos</h2>
            <div class="flex gap-1 text-[11px]">
              ${areas.map(a=>`
                <button class="px-2 py-1 rounded-lg ${State.areaAtual===a.id?"bg-emerald-500 text-slate-900":"bg-white/5 text-slate-200"}"
                        onclick="mudarArea('${a.id}')">${a.nome}</button>
              `).join("")}
            </div>
          </div>
          <div class="grid md:grid-cols-2 gap-3 max-h-[400px] overflow-y-auto pr-1">
            ${filaHtml}
          </div>
        </div>

        <div class="glass rounded-3xl p-4 border border-white/10 text-sm space-y-3">
          <h2 class="text-sm font-semibold text-slate-100 mb-2">Resumo de desempenho</h2>
          <div class="space-y-1 text-[11px] text-slate-300">
            <p>Criminal: ${State.stats.julgadosCriminal} julgados ‚Ä¢ IAJ: ${IAJ.toFixed(0)}% (${State.stats.acertosCriminal} acertos)</p>
            <p>Fam√≠lia: ${State.stats.julgadosFamilia} julgados</p>
            <p>Trabalhista: ${State.stats.julgadosTrabalhista} julgados</p>
            <p>STJ: ${State.stats.julgadosStj} recursos apreciados</p>
          </div>

          <div class="mt-4 border-t border-white/10 pt-3 text-xs text-slate-300">
            <p><span class="text-emerald-300 font-semibold">Modo Carreira</span> grava sua trajet√≥ria e desbloqueia STJ com bom desempenho.</p>
            <p class="mt-1"><span class="text-sky-300 font-semibold">Modo Estudo</span> permite treinar sem afetar sua carreira, ideal para aulas.</p>
          </div>
        </div>
      </section>
    </div>
  </div>`;
}

function renderReport() {
  const hist = State.history.slice().sort((a,b)=>b.ts-a.ts);
  const total = hist.length;
  const crim = hist.filter(h=>h.area==="criminal");
  const fam = hist.filter(h=>h.area==="familia");
  const trab = hist.filter(h=>h.area==="trabalhista");
  const stj = hist.filter(h=>h.area==="stj");

  function resumoArea(arr) {
    if (!arr.length) return "0 julgamentos.";
    const acertos = arr.filter(a=>a.acertou).length;
    const perc = (acertos/arr.length)*100;
    return `${arr.length} julgamentos ‚Ä¢ ${acertos} alinhados ao gabarito (${perc.toFixed(0)}%)`;
  }

  const linhas = hist.slice(0,25).map(h=>{
    const d = new Date(h.ts);
    const data = d.toLocaleDateString("pt-BR", {day:"2-digit",month:"2-digit"});
    return `
      <tr class="border-b border-white/5 text-[11px]">
        <td class="px-2 py-1">${data}</td>
        <td class="px-2 py-1">${h.modo==="career"?"Carreira":"Estudo"}</td>
        <td class="px-2 py-1 uppercase">${h.area}</td>
        <td class="px-2 py-1 truncate max-w-[120px]" title="${h.titulo}">${h.titulo}</td>
        <td class="px-2 py-1">${h.decisao}</td>
        <td class="px-2 py-1">${h.acertou?"‚úÖ":"‚ö†Ô∏è"}</td>
      </tr>`;
  }).join("");

  return `
  <div class="min-h-screen bg-court relative">
    <div class="absolute inset-0 bg-gradient-to-b from-black/85 via-black/75 to-black/90"></div>
    <div class="relative max-w-6xl mx-auto px-4 py-6 space-y-4">
      <button class="btn-soft" onclick="State.screen='office'; render();">‚Üê Voltar ao escrit√≥rio</button>

      <div class="glass rounded-3xl p-5 border border-emerald-400/30">
        <h2 class="text-2xl font-bold text-white mb-1">Relat√≥rio de desempenho</h2>
        <p class="text-xs text-slate-300 mb-3">
          Vis√£o geral da sua trajet√≥ria recente no simulador. Este relat√≥rio pode ser usado como base para discuss√£o em
          sala de aula, mentorias ou autoavalia√ß√£o.
        </p>

        <div class="grid md:grid-cols-2 gap-4 text-sm">
          <div class="space-y-2">
            <div>
              <div class="text-[11px] text-slate-400">Total de julgamentos (todos os modos)</div>
              <div class="text-lg font-semibold text-emerald-300">${total}</div>
            </div>
            <div>
              <div class="text-[11px] text-slate-400">Criminal</div>
              <div class="text-xs text-slate-200">${resumoArea(crim)}</div>
            </div>
            <div>
              <div class="text-[11px] text-slate-400">Fam√≠lia</div>
              <div class="text-xs text-slate-200">${resumoArea(fam)}</div>
            </div>
            <div>
              <div class="text-[11px] text-slate-400">Trabalhista</div>
              <div class="text-xs text-slate-200">${resumoArea(trab)}</div>
            </div>
            <div>
              <div class="text-[11px] text-slate-400">STJ</div>
              <div class="text-xs text-slate-200">${resumoArea(stj)}</div>
            </div>
          </div>

          <div class="text-xs text-slate-300">
            <p class="mb-2 font-semibold text-slate-100">Leitura pedag√≥gica sugerida:</p>
            <p>‚Ä¢ Se seu acerto em <span class="text-emerald-300">Criminal</span> estiver abaixo de 60%, vale revisar padr√µes
            de prova e o princ√≠pio do in dubio pro reo.</p>
            <p class="mt-1">‚Ä¢ Em <span class="text-emerald-300">Fam√≠lia</span>, concentre-se em fundamentar decis√µes sempre
            com foco no melhor interesse da crian√ßa, e n√£o em puni√ß√£o a genitores.</p>
            <p class="mt-1">‚Ä¢ Em <span class="text-emerald-300">Trabalhista</span>, observe com aten√ß√£o o √¥nus da prova e a coer√™ncia entre testemunhos e documentos.</p>
            <p class="mt-1">‚Ä¢ No <span class="text-emerald-300">STJ</span>, lembre que o foco √© a lei federal e a jurisprud√™ncia consolidada, e n√£o reexaminar toda a prova.</p>
          </div>
        </div>

        <div class="mt-6">
          <h3 class="text-sm font-semibold text-slate-100 mb-2">Linha do tempo recente (at√© 25 julgamentos)</h3>
          <div class="max-h-[260px] overflow-y-auto border border-white/10 rounded-xl">
            <table class="w-full text-left">
              <thead class="bg-white/5 text-[11px] text-slate-300">
                <tr>
                  <th class="px-2 py-1">Data</th>
                  <th class="px-2 py-1">Modo</th>
                  <th class="px-2 py-1">√Årea</th>
                  <th class="px-2 py-1">Caso</th>
                  <th class="px-2 py-1">Decis√£o</th>
                  <th class="px-2 py-1">Gabarito</th>
                </tr>
              </thead>
              <tbody>
                ${linhas || `<tr><td colspan="6" class="px-3 py-3 text-center text-[11px] text-slate-400">Ainda n√£o h√° julgamentos registrados.</td></tr>`}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>`;
}

function renderTrial() {
  const c = State.julgando;
  if (!c) { State.screen="office"; return render(); }

  const provasHtml = c.provas.map(p=>`
    <div class="rounded-lg bg-white/5 p-2 text-xs">
      <div class="text-[10px] uppercase text-emerald-300/80">${p.id} ‚Ä¢ ${p.tipo}</div>
      <div class="text-[11px] text-slate-100">${p.conteudo}</div>
    </div>
  `).join("");

  const juriArr = State.juri || [];
  const juriHtml = juriArr.length
    ? juriArr.map(j => {
        let cor = "bg-white/30";
        if (j.voto === true) cor = "bg-rose-500";      // condena
        if (j.voto === false) cor = "bg-emerald-500";  // absolve
        const w = j.certeza || 0;
        return `
          <div class="rounded-lg bg-white/5 p-1 text-[10px]">
            <div class="flex items-center justify-between mb-1">
              <span class="text-slate-200">J${String(j.id).padStart(2,'0')}</span>
              <span>${j.voto === null ? "‚Ä¶" : j.voto ? "Cond." : "Absol."}</span>
            </div>
            <div class="w-full h-1 bg-white/10 rounded">
              <div class="${cor} h-1 rounded" style="width:${w}%;"></div>
            </div>
          </div>`;
      }).join("")
    : `<div class="text-[11px] text-slate-400">Clique em "Simular delibera√ß√£o" para ver a tend√™ncia do j√∫ri.</div>`;

  return `
  <div class="min-h-screen bg-court relative">
    <div class="absolute inset-0 bg-gradient-to-b from-black/90 via-black/80 to-black/90"></div>
    <div class="relative max-w-6xl mx-auto px-4 py-5 space-y-4">
      <header class="flex items-center justify-between gap-3">
        <div>
          <div class="text-[11px] text-slate-300">Sala de audi√™ncia ‚Ä¢ ${
            c.tipo === "stj" ? "Recurso Especial" :
            c.tipo === "criminal" ? "Ju√≠zo Criminal" :
            c.tipo === "familia" ? "Vara de Fam√≠lia" : "Vara do Trabalho"
          }</div>
          <h1 class="text-xl font-bold text-white">${c.titulo}</h1>
          <div class="text-[11px] text-slate-400">Processo simulado ‚Ä¢ Provas dispon√≠veis: ${c.provas.length}</div>
        </div>
        <div class="flex gap-2 text-xs">
          <button class="btn-soft" onclick="toggleSound()">${State.soundsOn?'üîä Sons ON':'üîá Sons OFF'}</button>
          <button class="btn-soft" onclick="cancelarJulgamento()">Sair sem decidir</button>
        </div>
      </header>

      <section class="grid md:grid-cols-[1.4fr,1fr] gap-4">
        <div class="glass rounded-3xl p-4 border border-white/10 space-y-3">
          <!-- Avatares / Emotions -->
          <div class="flex gap-2 text-xs mb-2">
            <div class="flex items-center gap-2 rounded-xl bg-white/5 px-2 py-1">
              <div class="text-lg">‚öñÔ∏è</div>
              <div class="text-[11px]">
                <div class="font-semibold text-slate-100">Acusa√ß√£o</div>
                <div class="text-slate-300">Promotoria / Minist√©rio P√∫blico</div>
              </div>
            </div>
            <div class="flex items-center gap-2 rounded-xl bg-white/5 px-2 py-1">
              <div class="text-lg">üõ°Ô∏è</div>
              <div class="text-[11px]">
                <div class="font-semibold text-slate-100">Defesa</div>
                <div class="text-slate-300">Advogado(a) do r√©u / parte</div>
              </div>
            </div>
          </div>

          <div class="flex flex-wrap gap-2 text-[11px]">
            <button class="btn-soft" onclick="exposicaoInicial('acusacao')">Palavra √† acusa√ß√£o</button>
            <button class="btn-soft" onclick="exposicaoInicial('defesa')">Ouvir defesa</button>
          </div>

          <div class="text-xs text-slate-200">
            <div class="text-[10px] uppercase text-emerald-300/80 mb-1">Exposi√ß√£o da acusa√ß√£o</div>
            <pre id="txtAcus" class="min-h-[60px] text-[11px] bg-white/5 rounded-lg p-2"></pre>
          </div>

          <div class="text-xs text-slate-200">
            <div class="text-[10px] uppercase text-emerald-300/80 mb-1">Exposi√ß√£o da defesa</div>
            <pre id="txtDef" class="min-h-[60px] text-[11px] bg-white/5 rounded-lg p-2"></pre>
          </div>

          <div class="text-xs text-slate-200">
            <div class="text-[10px] uppercase text-emerald-300/80 mb-1">Perguntas do juiz</div>
            <div class="flex gap-2 mb-2">
              <input id="inpPerg" class="flex-1 rounded-lg bg-white/10 px-2 py-1 text-[11px] outline-none"
                     placeholder="Ex.: H√° contradi√ß√µes entre o laudo e o depoimento da testemunha? Cite o documento." />
              <button class="btn-main text-[11px]" onclick="perguntarIA()">Perguntar</button>
            </div>
            <pre id="txtResp" class="min-h-[50px] text-[11px] bg-white/5 rounded-lg p-2"></pre>
          </div>

          <div class="border-t border-white/10 pt-3 flex flex-col md:flex-row md:items-center md:justify-between gap-2 text-xs">
            <div class="text-slate-300">
              Pronto para decidir? Considere o padr√£o probat√≥rio:
              <span class="text-emerald-300 font-semibold">${
                c.tipo === "criminal" || c.ramo === "criminal"
                  ? "Al√©m de d√∫vida razo√°vel"
                  : "Preponder√¢ncia das provas / melhor interesse"
              }</span>.
            </div>
            <div class="flex gap-2">
              <button class="btn-soft" onclick="darVeredito(false)">Absolver / Improcedente</button>
              <button class="btn-main" onclick="darVeredito(true)">Condenar / Procedente</button>
            </div>
          </div>
        </div>

        <div class="glass rounded-3xl p-4 border border-white/10 space-y-2 text-xs">
          <h2 class="text-sm font-semibold text-slate-100">Dossi√™ de provas</h2>
          <p class="text-[11px] text-slate-300">Cada documento pode ser citado na fundamenta√ß√£o: boletim, laudo, depoimento, mensagens‚Ä¶</p>
          <div class="grid gap-2 max-h-[260px] overflow-y-auto pr-1">
            ${provasHtml}
          </div>

          <div class="border-t border-white/10 pt-3 mt-3">
            <div class="flex items-center justify-between text-[11px] text-slate-300 mb-1">
              <span>J√∫ri popular (simulado)</span>
              <button class="btn-soft px-2 py-1 text-[10px]" onclick="simularJuri()">Simular delibera√ß√£o</button>
            </div>
            <div class="grid grid-cols-4 gap-1 max-h-[120px] overflow-y-auto pr-1">
              ${juriHtml}
            </div>
            <p class="text-[10px] text-slate-400 mt-1">
              Indicativo visual da tend√™ncia do j√∫ri: vermelho = condena√ß√£o, verde = absolvi√ß√£o, largura = grau de certeza.
            </p>
          </div>
        </div>
      </section>
    </div>
  </div>`;
}

/* ==========================
   RENDER PRINCIPAL
   ========================== */

function render() {
  const app = document.getElementById("app");
  let html = "";
  switch(State.screen) {
    case "splash": html = renderSplash(); stopAmbience(); break;
    case "tutorial": html = renderTutorial(); stopAmbience(); break;
    case "login": html = renderLogin(); stopAmbience(); break;
    case "office": html = renderOffice(); startAmbience(); break;
    case "trial": html = renderTrial(); startAmbience(); break;
    case "report": html = renderReport(); stopAmbience(); break;
  }
  app.innerHTML = html;
}

/* ==========================
   A√á√ïES DE INTERFACE
   ========================== */

function toggleSound() {
  State.soundsOn = !State.soundsOn;
  if (!State.soundsOn) { stopAmbience(); }
  render();
}

function irModo(mode) {
  State.mode = mode;      // career ou study
  State.screen = "login";
  render();
}

function confirmarLogin() {
  const nome = document.getElementById("inpNome").value.trim();
  const idade = document.getElementById("inpIdade").value.trim();
  const estado = document.getElementById("inpEstado").value.trim() || "SP";
  const cidade = document.getElementById("inpCidade").value.trim() || "S√£o Paulo";
  if (!nome || !idade) {
    alert("Preencha nome e idade para continuar.");
    return;
  }
  State.player = {nome, idade, estado, cidade};
  State.screen = "office";
  montarFila();
  if (State.mode === "career") saveCareer(true);
  render();
}

function carregarLocal() {
  const ok = loadCareer();
  if (!ok || !State.player) {
    alert("Nenhum save de carreira encontrado neste navegador.");
    return;
  }
  State.mode = "career";
  State.screen = "office";
  montarFila();
  render();
}

function mudarArea(area) {
  State.areaAtual = area;
  montarFila();
  render();
}

function verCaso(id) {
  const c = State.cases.find(x=>x.id===id);
  if (!c) return;
  State.julgando = c;
  State.lastExposicaoAcus = "";
  State.lastExposicaoDef = "";
  State.lastResposta = "";
  initJuri(c);
  State.screen = "trial";
  play("#s-murmur",0.4);
  render();
}

function iniciarJulgamento(id) {
  verCaso(id);
}

function cancelarJulgamento() {
  State.julgando = null;
  State.lastExposicaoAcus = "";
  State.lastExposicaoDef = "";
  State.lastResposta = "";
  State.juri = [];
  State.screen = "office";
  render();
}

function exposicaoInicial(lado) {
  if (!State.julgando) return;
  const txt = iaExposicaoInicial(lado, State.julgando);
  if (lado === "acusacao") {
    State.lastExposicaoAcus = txt;
  } else {
    State.lastExposicaoDef = txt;
  }
  // renderiza, depois aplica o efeito typewriter
  render();
  setTimeout(() => {
    typewriterText(lado === "acusacao" ? "txtAcus" : "txtDef", txt, 12);
  }, 30);
}

function perguntarIA() {
  const inp = document.getElementById("inpPerg");
  if (!inp || !State.julgando) return;
  const q = inp.value.trim();
  if (!q) return;
  const lado = Math.random()<0.5 ? "acusacao" : "defesa";
  const txt = analisarPergunta(q, State.julgando, lado, State.lastResposta || State.lastExposicaoAcus || State.lastExposicaoDef);
  State.lastResposta = txt;
  State.ultimoTextoPergunta = q;
  inp.value = "";
  render();
  setTimeout(() => {
    typewriterText("txtResp", txt, 14);
  }, 30);
}

function darVeredito(culp) {
  if (!State.julgando) return;
  play("#s-gavel",0.9);
  const caso = State.julgando;
  registrarVeredito(caso, culp);
  // tira da fila
  State.fila = State.fila.filter(x=>x.id!==caso.id);
  State.julgando = null;
  State.juri = [];
  State.screen = "office";
  render();
}

/* ==========================
   INIT
   ========================== */

function init() {
  State.cases = seedCases();
  State.screen = "splash";
  render();
}

document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
